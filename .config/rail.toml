# cargo-rail configuration
# Documentation: https://github.com/loadingalias/cargo-rail

# Targets for multi-platform validation (runs `cargo metadata --filter-platform <target>` per target)
targets = [
  "aarch64-apple-darwin",
  "aarch64-unknown-linux-gnu",
  "i686-pc-windows-msvc",
  "riscv64gc-unknown-linux-gnu",
  "x86_64-apple-darwin",
  "x86_64-pc-windows-gnu",
  "x86_64-pc-windows-msvc",
  "x86_64-unknown-linux-gnu",
]

[unify]
include_paths = true
include_renamed = false

pin_transitives = false  # enable for hakari/workspace-hack users
transitive_host = "root"  # only used if pin_transitives = true

strict_version_compat = true
exact_pin_handling = "warn"
major_version_conflict = "bump"  # warn = skip, bump = force highest

msrv = true
msrv_source = "deps"  # compute from dependency graph
enforce_msrv_inheritance = false

detect_unused = true
remove_unused = true  # requires detect_unused = true

prune_dead_features = true
preserve_features = []  # glob patterns to keep from pruning
detect_undeclared_features = true
fix_undeclared_features = true  # requires detect_undeclared_features = true
skip_undeclared_patterns = [
  "default",
  "std",
  "alloc",
  "*_backend",
  "*_impl",
]

exclude = []
include = []
max_backups = 3
sort_dependencies = false  # preserve upstream order for PR acceptance


[release]
tag_prefix = "v"
tag_format = "{crate}-{prefix}{version}"  # e.g. my-crate-v1.0.0 (with tag_prefix = "v")
require_clean = true
publish_delay = 5  # seconds between publishes
create_github_release = false
sign_tags = false
changelog_path = "CHANGELOG.md"
changelog_relative_to = "crate"  # crate = per-crate, workspace = single file
skip_changelog_for = []
require_changelog_entries = false


[change-detection]
# Paths that trigger full workspace rebuild
# Note: languages.toml affects grammar cache, correctly triggers infra
infrastructure = [
  ".github/**",
  "flake.nix",
  "flake.lock",
  "default.nix",
  "shell.nix",
  "rust-toolchain.toml",
  "languages.toml",  # Grammar definitions - affects tree-sitter cache
]
conservative_unclassified_owner_fallback = true
confidence_profile = "balanced"
bot_pr_confidence_profile = "strict"

# Custom surfaces for helix's runtime assets
[change-detection.custom]
# Themes: color schemes that don't need build/test
themes = ["runtime/themes/**"]
# Queries: tree-sitter queries that need validation but not full rebuild
queries = ["runtime/queries/**"]
# Book: documentation that needs mdbook build
book = ["book/**"]
# Xtask: build tooling
xtask = ["xtask/**"]


[run]
default_profile = "local"

# Map workflow names to profiles (from build.yml jobs)
[run.workflow]
build = "ci"      # check, test, lints jobs
check = "msrv"    # MSRV check job
test = "test"     # test suite job
lints = "lint"    # lints job (fmt, clippy, doc)
docs = "docs"     # docs job (query-check, theme-check, docgen)

# Main CI profile - build and test
[run.profile.ci]
surfaces = ["build", "test"]
merge_base = true

# MSRV check - build only
[run.profile.msrv]
surfaces = ["build"]
merge_base = true

# Test suite - test surface
[run.profile.test]
surfaces = ["test"]
merge_base = true

# Lint profile - build surface (clippy needs build)
[run.profile.lint]
surfaces = ["build"]
merge_base = true

# Docs profile - for documentation changes
# Note: custom:themes and custom:queries are plan OUTPUTS, used in CI gating
[run.profile.docs]
surfaces = ["docs"]
merge_base = true


# Per-crate configuration: run 'cargo rail split init <crate>' to generate
# [crates.my-crate.split]
# remote = "git@github.com:org/my-crate.git"
# branch = "main"
# mode = "single"
# paths = [{ crate = "crates/my-crate" }]
